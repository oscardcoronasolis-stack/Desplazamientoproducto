/**
 * Construcción dinámica de queries SQL
 */



function buildDashboardQuery(filters = {}) {
  const tablePath = getFullTablePath();
  
  const whereConditions = [];
  
  Object.keys(filters).forEach(column => {
    const values = filters[column];
    if (values && values.length > 0) {
      // Manejar MODELO como numérico
      if (column === 'MODELO') {
        const numericValues = values.join(',');
        whereConditions.push(`${column} IN (${numericValues})`);
      } else {
        const escapedValues = values.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
        whereConditions.push(`${column} IN (${escapedValues})`);
      }
    }
  });
  
  const whereClause = whereConditions.length > 0 
    ? `WHERE ${whereConditions.join(' AND ')}` 
    : '';
  
  const sql = `
    SELECT
      SUM(${CONFIG.METRICS.INVENTARIO}) AS Inventario,
      SUM(${CONFIG.METRICS.VENTA}) AS Venta,
      SUM(${CONFIG.METRICS.COMPRA}) AS Compra,
      SAFE_DIVIDE(SUM(${CONFIG.METRICS.VENTA}), SUM(${CONFIG.METRICS.COMPRA})) AS PorcentajeST
    FROM ${tablePath}
    ${whereClause}
  `;
  
  return sql;
}


function buildTableQuery(filters = {}, selectedModels = [], selectedCollections = [], selectedCategorias = []) {
  const tablePath = getFullTablePath();
  
  const whereConditions = [];
  
  // Aplicar filtros globales
  Object.keys(filters).forEach(column => {
    const values = filters[column];
    if (values && values.length > 0) {
      // Manejar MODELO como numérico
      if (column === 'MODELO') {
        const numericValues = values.join(',');
        whereConditions.push(`${column} IN (${numericValues})`);
      } else {
        const escapedValues = values.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
        whereConditions.push(`${column} IN (${escapedValues})`);
      }
    }
  });
  
  // Filtros de selecciones en tablas
  if (selectedModels && selectedModels.length > 0) {
    const numericModels = selectedModels.join(',');
    whereConditions.push(`MODELO IN (${numericModels})`);
  }
  
  if (selectedCollections && selectedCollections.length > 0) {
    const escapedCollections = selectedCollections.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
    whereConditions.push(`Collection IN (${escapedCollections})`);
  }
  
  if (selectedCategorias && selectedCategorias.length > 0) {
    const escapedCategorias = selectedCategorias.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
    whereConditions.push(`Cat_1 IN (${escapedCategorias})`);
  }
  
  const whereClause = whereConditions.length > 0 
    ? `WHERE ${whereConditions.join(' AND ')}` 
    : '';
  
  const sql = `
    WITH Aggregated AS (
      SELECT
        Tienda,
        SUM(${CONFIG.METRICS.COMPRA}) AS Compra,
        SUM(${CONFIG.METRICS.VENTA}) AS Venta,
        SUM(${CONFIG.METRICS.INVENTARIO}) AS Inventario,
        SAFE_DIVIDE(SUM(${CONFIG.METRICS.VENTA}), SUM(${CONFIG.METRICS.COMPRA})) AS PorcentajeST
      FROM ${tablePath}
      ${whereClause}
      GROUP BY Tienda
    )
    SELECT *
    FROM Aggregated
    WHERE Compra >= 3
      AND Tienda NOT IN ('MORELIAAMERICAS', 'OUTLETPUEBLA')
    ORDER BY PorcentajeST DESC
  `;
  
  return sql;
}

function buildModelTableQuery(filters = {}, selectedStores = [], selectedCollections = [], selectedCategorias = []) {
  const tablePath = getFullTablePath();
  
  const whereConditions = [];
  
  // Aplicar filtros globales
  Object.keys(filters).forEach(column => {
    const values = filters[column];
    if (values && values.length > 0) {
      // Manejar MODELO como numérico
      if (column === 'MODELO') {
        const numericValues = values.join(',');
        whereConditions.push(`${column} IN (${numericValues})`);
      } else {
        const escapedValues = values.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
        whereConditions.push(`${column} IN (${escapedValues})`);
      }
    }
  });
  
  // Filtros de selecciones en tablas
  if (selectedStores && selectedStores.length > 0) {
    const escapedStores = selectedStores.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
    whereConditions.push(`Tienda IN (${escapedStores})`);
  }
  
  if (selectedCollections && selectedCollections.length > 0) {
    const escapedCollections = selectedCollections.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
    whereConditions.push(`Collection IN (${escapedCollections})`);
  }
  
  if (selectedCategorias && selectedCategorias.length > 0) {
    const escapedCategorias = selectedCategorias.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
    whereConditions.push(`Cat_1 IN (${escapedCategorias})`);
  }
  
  const whereClause = whereConditions.length > 0 
    ? `WHERE ${whereConditions.join(' AND ')}` 
    : '';
  
  const sql = `
    WITH Aggregated AS (
      SELECT
        MODELO,
        MAX(Cat_1) AS Categoria,
        SUM(${CONFIG.METRICS.COMPRA}) AS Compra,
        SUM(${CONFIG.METRICS.VENTA}) AS Venta,
        SUM(${CONFIG.METRICS.INVENTARIO}) AS Inventario,
        SAFE_DIVIDE(SUM(${CONFIG.METRICS.VENTA}), SUM(${CONFIG.METRICS.COMPRA})) AS PorcentajeST
      FROM ${tablePath}
      ${whereClause}
      GROUP BY MODELO
    )
    SELECT *
    FROM Aggregated
    WHERE Compra >= 3
    ORDER BY PorcentajeST DESC
  `;
  
  return sql;
}

function buildCollectionTableQuery(filters = {}, selectedModels = [], selectedStores = [], selectedCategorias = []) {
  const tablePath = getFullTablePath();
  
  const whereConditions = [];
  
  // Aplicar filtros globales
  Object.keys(filters).forEach(column => {
    const values = filters[column];
    if (values && values.length > 0) {
      // Manejar MODELO como numérico
      if (column === 'MODELO') {
        const numericValues = values.join(',');
        whereConditions.push(`${column} IN (${numericValues})`);
      } else {
        const escapedValues = values.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
        whereConditions.push(`${column} IN (${escapedValues})`);
      }
    }
  });
  
  // Filtros de selecciones en tablas
  if (selectedModels && selectedModels.length > 0) {
    const numericModels = selectedModels.join(',');
    whereConditions.push(`MODELO IN (${numericModels})`);
  }
  
  if (selectedStores && selectedStores.length > 0) {
    const escapedStores = selectedStores.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
    whereConditions.push(`Tienda IN (${escapedStores})`);
  }
  
  if (selectedCategorias && selectedCategorias.length > 0) {
    const escapedCategorias = selectedCategorias.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
    whereConditions.push(`Cat_1 IN (${escapedCategorias})`);
  }
  
  const whereClause = whereConditions.length > 0 
    ? `WHERE ${whereConditions.join(' AND ')}` 
    : '';
  
  const sql = `
    WITH Aggregated AS (
      SELECT
        Collection,
        SUM(${CONFIG.METRICS.COMPRA}) AS Compra,
        SUM(${CONFIG.METRICS.VENTA}) AS Venta,
        SUM(${CONFIG.METRICS.INVENTARIO}) AS Inventario,
        SAFE_DIVIDE(SUM(${CONFIG.METRICS.VENTA}), SUM(${CONFIG.METRICS.COMPRA})) AS PorcentajeST
      FROM ${tablePath}
      ${whereClause}
      GROUP BY Collection
    )
    SELECT *
    FROM Aggregated
    WHERE Compra >= 3
    ORDER BY PorcentajeST DESC
  `;
  
  return sql;
}

function buildCategoriaTableQuery(filters = {}, selectedModels = [], selectedStores = [], selectedCollections = []) {
  const tablePath = getFullTablePath();
  
  const whereConditions = [];
  
  // Aplicar filtros globales
  Object.keys(filters).forEach(column => {
    const values = filters[column];
    if (values && values.length > 0) {
      // Manejar MODELO como numérico
      if (column === 'MODELO') {
        const numericValues = values.join(',');
        whereConditions.push(`${column} IN (${numericValues})`);
      } else {
        const escapedValues = values.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
        whereConditions.push(`${column} IN (${escapedValues})`);
      }
    }
  });
  
  // Filtros de selecciones en tablas
  if (selectedModels && selectedModels.length > 0) {
    const numericModels = selectedModels.join(',');
    whereConditions.push(`MODELO IN (${numericModels})`);
  }
  
  if (selectedStores && selectedStores.length > 0) {
    const escapedStores = selectedStores.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
    whereConditions.push(`Tienda IN (${escapedStores})`);
  }
  
  if (selectedCollections && selectedCollections.length > 0) {
    const escapedCollections = selectedCollections.map(v => `'${v.replace(/'/g, "\\'")}'`).join(',');
    whereConditions.push(`Collection IN (${escapedCollections})`);
  }
  
  const whereClause = whereConditions.length > 0 
    ? `WHERE ${whereConditions.join(' AND ')}` 
    : '';
  
  const sql = `
    WITH Aggregated AS (
      SELECT
        Cat_1 AS Categoria,
        SUM(${CONFIG.METRICS.COMPRA}) AS Compra,
        SUM(${CONFIG.METRICS.VENTA}) AS Venta,
        SUM(${CONFIG.METRICS.INVENTARIO}) AS Inventario,
        SAFE_DIVIDE(SUM(${CONFIG.METRICS.VENTA}), SUM(${CONFIG.METRICS.COMPRA})) AS PorcentajeST
      FROM ${tablePath}
      ${whereClause}
      GROUP BY Cat_1
    )
    SELECT *
    FROM Aggregated
    WHERE Compra >= 3
    ORDER BY PorcentajeST DESC
  `;
  
  return sql;
}

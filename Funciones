<script>
// ========== ESTADO GLOBAL ==========
const appState = {
  activeFilters: {},
  filterData: {},
  selectedStores: [],
  selectedModels: [],
  globalSTPercent: 0,
  tiendasData: [],
  modelosData: [],
  sortStateTiendas: { column: null, ascending: true },
  sortStateModelos: { column: null, ascending: true }
};

// ========== INICIALIZACIÓN ==========
window.addEventListener('DOMContentLoaded', () => {
  initializeApp();
});

function initializeApp() {
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(onFilterDataLoaded)
    .withFailureHandler(onError)
    .getInitialFilterData();
  
  setupEventListeners();
}

function setupEventListeners() {
  document.getElementById('btnClearAll').addEventListener('click', clearAllAndSelections);
  document.getElementById('btnRefresh').addEventListener('click', refreshData);
  
  // Sorting en columnas
  document.querySelectorAll('#dataTableTiendas th.sortable').forEach(th => {
    th.addEventListener('click', (e) => handleSort(e, 'tiendas'));
  });
  
  document.querySelectorAll('#dataTableModelos th.sortable').forEach(th => {
    th.addEventListener('click', (e) => handleSort(e, 'modelos'));
  });
}

// ========== MANEJO DE FILTROS ==========
function onFilterDataLoaded(data) {
  appState.filterData = data;
  renderFilters(data);
  
  // Default: Línea = Couture
  if (data['Linea'] && data['Linea'].options.includes('Couture')) {
    appState.activeFilters['Linea'] = ['Couture'];
    const lineaSelect = document.getElementById('filter_Linea');
    if (lineaSelect) {
      Array.from(lineaSelect.options).forEach(opt => {
        if (opt.value === 'Couture') {
          opt.selected = true;
        }
      });
      lineaSelect.style.fontWeight = '600';
    }
    updateAllDependentFilters();
  } else {
    loadAllData();
  }
}

function renderFilters(filterData) {
  const container = document.getElementById('filtersHorizontal');
  container.innerHTML = '';
  
  const orderedColumns = ['_Temp', 'Linea', 'Collection', 'Tienda', 'Cat_1', 'Cat_2', 'MODELO', 'COLOR', 'TALLA'];
  
  orderedColumns.forEach(columnName => {
    if (!filterData[columnName]) return;
    
    const filter = filterData[columnName];
    
    const filterGroup = document.createElement('div');
    filterGroup.className = 'filter-group';
    
    const label = document.createElement('label');
    label.className = 'filter-label';
    label.textContent = filter.label;
    
    const selectWrapper = document.createElement('div');
    selectWrapper.className = 'select-wrapper';
    
    const select = document.createElement('select');
    select.className = 'filter-select';
    select.id = `filter_${columnName}`;
    select.multiple = true;
    select.size = 1;
    
    filter.options.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt;
      option.textContent = opt;
      select.appendChild(option);
    });
    
    select.addEventListener('change', () => handleFilterChange(columnName, select));
    
    selectWrapper.appendChild(select);
    filterGroup.appendChild(label);
    filterGroup.appendChild(selectWrapper);
    container.appendChild(filterGroup);
  });
}

function handleFilterChange(columnName, selectElement) {
  const selectedOptions = Array.from(selectElement.selectedOptions)
    .map(opt => opt.value)
    .filter(val => val !== '');
  
  if (selectedOptions.length > 0) {
    appState.activeFilters[columnName] = selectedOptions;
    selectElement.style.fontWeight = '600';
  } else {
    delete appState.activeFilters[columnName];
    selectElement.style.fontWeight = '400';
  }
  
  updateAllDependentFilters();
}

function updateAllDependentFilters() {
  showLoading(true);
  
  // Orden correcto de actualización (de menos dependiente a más dependiente)
  const orderedColumns = ['Collection', 'Tienda', 'Cat_1', 'Cat_2', 'MODELO', 'COLOR', 'TALLA'];
  let completedUpdates = 0;
  const totalUpdates = orderedColumns.length;
  
  function checkComplete() {
    completedUpdates++;
    if (completedUpdates === totalUpdates) {
      loadAllData();
    }
  }
  
  orderedColumns.forEach(columnName => {
    const select = document.getElementById(`filter_${columnName}`);
    if (!select) {
      checkComplete();
      return;
    }
    
    // Pasar TODOS los filtros activos actuales
    google.script.run
      .withSuccessHandler(function(options) {
        updateSelectOptions(select, columnName, options);
        checkComplete();
      })
      .withFailureHandler(function(error) {
        console.error('Error actualizando ' + columnName, error);
        checkComplete();
      })
      .getFilterOptionsWithDependency(columnName, appState.activeFilters);
  });
}

function updateSelectOptions(selectElement, columnName, options) {
  const currentValues = appState.activeFilters[columnName] || [];
  
  selectElement.innerHTML = '';
  
  options.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt;
    option.textContent = opt;
    if (currentValues.includes(opt)) {
      option.selected = true;
    }
    selectElement.appendChild(option);
  });
  
  // Si valores actuales ya no existen, limpiarlos
  const validValues = currentValues.filter(v => options.includes(v));
  if (validValues.length !== currentValues.length) {
    if (validValues.length > 0) {
      appState.activeFilters[columnName] = validValues;
      selectElement.style.fontWeight = '600';
    } else {
      delete appState.activeFilters[columnName];
      selectElement.style.fontWeight = '400';
    }
  }
}

function clearAllAndSelections() {
  appState.activeFilters = {};
  appState.selectedStores = [];
  appState.selectedModels = [];
  
  google.script.run
    .withSuccessHandler(function(data) {
      appState.filterData = data;
      renderFilters(data);
      
      // Re-aplicar default Couture
      if (data['Linea'] && data['Linea'].options.includes('Couture')) {
        appState.activeFilters['Linea'] = ['Couture'];
        const lineaSelect = document.getElementById('filter_Linea');
        if (lineaSelect) {
          Array.from(lineaSelect.options).forEach(opt => {
            if (opt.value === 'Couture') {
              opt.selected = true;
            }
          });
          lineaSelect.style.fontWeight = '600';
        }
        updateAllDependentFilters();
      } else {
        loadAllData();
      }
    })
    .withFailureHandler(onError)
    .getInitialFilterData();
}

// ========== CARGA DE DATOS ==========
function loadAllData() {
  showLoading(true);
  
  let completedCalls = 0;
  const totalCalls = 3;
  
  function checkComplete() {
    completedCalls++;
    if (completedCalls === totalCalls) {
      showLoading(false);
    }
  }
  
  google.script.run
    .withSuccessHandler(function(data) {
      onDataLoaded(data);
      checkComplete();
    })
    .withFailureHandler(onError)
    .getDashboardData(appState.activeFilters);
  
  google.script.run
    .withSuccessHandler(function(data) {
      appState.tiendasData = data;
      renderTableData('tiendas', data);
      checkComplete();
    })
    .withFailureHandler(onError)
    .getTableData(appState.activeFilters, appState.selectedModels);
  
  google.script.run
    .withSuccessHandler(function(data) {
      appState.modelosData = data;
      renderTableData('modelos', data);
      checkComplete();
    })
    .withFailureHandler(onError)
    .getModelTableData(appState.activeFilters, appState.selectedStores);
}

function onDataLoaded(data) {
  appState.globalSTPercent = data.porcentajeST;
  
  document.getElementById('kpiCompra').textContent = formatNumber(data.compra);
  document.getElementById('kpiVenta').textContent = formatNumber(data.venta);
  document.getElementById('kpiInventario').textContent = formatNumber(data.inventario);
  document.getElementById('kpiPorcentaje').textContent = formatPercentage(data.porcentajeST);
}

function renderTableData(tableType, data) {
  const tbody = document.getElementById(tableType === 'tiendas' ? 'tableBodyTiendas' : 'tableBodyModelos');
  tbody.innerHTML = '';
  
  data.forEach(row => {
    const tr = document.createElement('tr');
    
    if (tableType === 'tiendas') {
      tr.dataset.tienda = row.tienda;
      if (appState.selectedStores.includes(row.tienda)) {
        tr.classList.add('selected');
      }
      tr.addEventListener('click', () => handleStoreClick(row.tienda, tr));
      
      const tdTienda = document.createElement('td');
      tdTienda.textContent = row.tienda;
      tdTienda.title = row.tienda;
      tr.appendChild(tdTienda);
      
    } else {
      tr.dataset.modelo = row.modelo;
      if (appState.selectedModels.includes(row.modelo)) {
        tr.classList.add('selected');
      }
      tr.addEventListener('click', () => handleModelClick(row.modelo, tr));
      
      const tdModelo = document.createElement('td');
      tdModelo.textContent = row.modelo;
      tdModelo.title = row.modelo;
      tr.appendChild(tdModelo);
      
      const tdCategoria = document.createElement('td');
      tdCategoria.textContent = row.categoria;
      tr.appendChild(tdCategoria);
    }
    
    const tdCompra = document.createElement('td');
    tdCompra.className = 'text-center';
    tdCompra.textContent = formatNumber(row.compra);
    
    const tdVenta = document.createElement('td');
    tdVenta.className = 'text-center';
    tdVenta.textContent = formatNumber(row.venta);
    
    const tdInventario = document.createElement('td');
    tdInventario.className = 'text-center';
    tdInventario.textContent = formatNumber(row.inventario);
    
    const tdPorcentaje = document.createElement('td');
    tdPorcentaje.className = 'text-right';
    tdPorcentaje.textContent = formatPercentage(row.porcentajeST);
    
    applyRedGradient(tdPorcentaje, row.porcentajeST, appState.globalSTPercent);
    
    tr.appendChild(tdCompra);
    tr.appendChild(tdVenta);
    tr.appendChild(tdInventario);
    tr.appendChild(tdPorcentaje);
    
    tbody.appendChild(tr);
  });
}

// ========== SORTING ==========
function handleSort(event, tableType) {
  const column = event.target.dataset.column;
  if (!column) return;
  
  const sortState = tableType === 'tiendas' ? appState.sortStateTiendas : appState.sortStateModelos;
  
  if (sortState.column === column) {
    sortState.ascending = !sortState.ascending;
  } else {
    sortState.column = column;
    sortState.ascending = true;
  }
  
  // Limpiar clases de ordenamiento
  document.querySelectorAll(`#dataTable${tableType === 'tiendas' ? 'Tiendas' : 'Modelos'} th`).forEach(th => {
    th.classList.remove('sorted-asc', 'sorted-desc');
  });
  
  // Aplicar clase actual
  event.target.classList.add(sortState.ascending ? 'sorted-asc' : 'sorted-desc');
  
  // Ordenar datos
  const data = tableType === 'tiendas' ? [...appState.tiendasData] : [...appState.modelosData];
  
  data.sort((a, b) => {
    let valA = a[column];
    let valB = b[column];
    
    if (typeof valA === 'string') {
      valA = valA.toLowerCase();
      valB = valB.toLowerCase();
    }
    
    if (valA < valB) return sortState.ascending ? -1 : 1;
    if (valA > valB) return sortState.ascending ? 1 : -1;
    return 0;
  });
  
  renderTableData(tableType, data);
}

// ========== MANEJO DE SELECCIONES ==========
function handleStoreClick(tienda, rowElement) {
  const index = appState.selectedStores.indexOf(tienda);
  
  if (index > -1) {
    appState.selectedStores.splice(index, 1);
    rowElement.classList.remove('selected');
  } else {
    appState.selectedStores.push(tienda);
    rowElement.classList.add('selected');
  }
  
  reloadModelTable();
}

function handleModelClick(modelo, rowElement) {
  const index = appState.selectedModels.indexOf(modelo);
  
  if (index > -1) {
    appState.selectedModels.splice(index, 1);
    rowElement.classList.remove('selected');
  } else {
    appState.selectedModels.push(modelo);
    rowElement.classList.add('selected');
  }
  
  reloadStoreTable();
}

function reloadStoreTable() {
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(data) {
      appState.tiendasData = data;
      renderTableData('tiendas', data);
      showLoading(false);
    })
    .withFailureHandler(onError)
    .getTableData(appState.activeFilters, appState.selectedModels);
}

function reloadModelTable() {
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(data) {
      appState.modelosData = data;
      renderTableData('modelos', data);
      showLoading(false);
    })
    .withFailureHandler(onError)
    .getModelTableData(appState.activeFilters, appState.selectedStores);
}

// ========== FORMATO DE DEGRADADO ROJO ==========
function applyRedGradient(element, value, threshold) {
  if (value >= threshold) return;
  
  const diff = threshold - value;
  const maxDiff = threshold;
  const intensity = Math.min(diff / maxDiff, 1);
  
  if (intensity <= 0.2) {
    element.classList.add('percent-red-1');
  } else if (intensity <= 0.4) {
    element.classList.add('percent-red-2');
  } else if (intensity <= 0.6) {
    element.classList.add('percent-red-3');
  } else if (intensity <= 0.8) {
    element.classList.add('percent-red-4');
  } else {
    element.classList.add('percent-red-5');
  }
}

function refreshData() {
  loadAllData();
}

// ========== UI HELPERS ==========
function showLoading(show) {
  document.getElementById('loading').classList.toggle('active', show);
}

function onError(error) {
  console.error('Error:', error);
  alert('Error al cargar datos: ' + error.message);
  showLoading(false);
}

// ========== FORMATEO ==========
function formatNumber(num) {
  return new Intl.NumberFormat('es-MX').format(Math.round(num));
}

function formatPercentage(num) {
  return num.toFixed(1) + '%';
}
</script>

<script>
// ========== ESTADO GLOBAL ==========
const appState = {
  activeFilters: {},
  filterData: {},
  selectedStores: [],
  selectedModels: [],
  selectedCollections: [],
  selectedCategorias: [],
  globalSTPercent: 0,
  tiendasData: [],
  modelosData: [],
  coleccionesData: [],
  categoriasData: [],
  imagenesModelos: {},
  sortStateTiendas: { column: null, ascending: true },
  sortStateModelos: { column: null, ascending: true },
  sortStateColecciones: { column: null, ascending: true },
  sortStateCategorias: { column: null, ascending: true }
};

// ========== INICIALIZACIÓN ==========
window.addEventListener('DOMContentLoaded', () => {
  initializeApp();
});

function initializeApp() {
  showLoading(true);
  
  // Cargar catálogo de imágenes primero
  google.script.run
    .withSuccessHandler(function(catalogo) {
      appState.imagenesModelos = catalogo;
      
      // DEBUGGING - Ver en consola del navegador
      console.log('=== CATÁLOGO DE IMÁGENES CARGADO ===');
      console.log('Total imágenes:', Object.keys(catalogo).length);
      console.log('Modelos con imagen:', Object.keys(catalogo));
      console.log('Catálogo completo:', catalogo);
      console.log('=====================================');
      
      // Luego cargar filtros
      google.script.run
        .withSuccessHandler(onFilterDataLoaded)
        .withFailureHandler(onError)
        .getInitialFilterData();
    })
    .withFailureHandler(onError)
    .getCatalogoImagenes();
  
  setupEventListeners();
}

function setupEventListeners() {
  document.getElementById('btnClearAll').addEventListener('click', clearAllAndSelections);
  document.getElementById('btnRefresh').addEventListener('click', refreshData);
  
  // Modal de imagen
  document.getElementById('imageModal').addEventListener('click', closeImageModal);
  document.getElementById('imageModalClose').addEventListener('click', closeImageModal);
  
  // Sorting en columnas
  document.querySelectorAll('#dataTableTiendas th.sortable').forEach(th => {
    th.addEventListener('click', (e) => handleSort(e, 'tiendas'));
  });
  
  document.querySelectorAll('#dataTableModelos th.sortable').forEach(th => {
    th.addEventListener('click', (e) => handleSort(e, 'modelos'));
  });
  
  document.querySelectorAll('#dataTableColecciones th.sortable').forEach(th => {
    th.addEventListener('click', (e) => handleSort(e, 'colecciones'));
  });
  
  document.querySelectorAll('#dataTableCategorias th.sortable').forEach(th => {
    th.addEventListener('click', (e) => handleSort(e, 'categorias'));
  });
}

// ========== MANEJO DE FILTROS ==========
function onFilterDataLoaded(data) {
  appState.filterData = data;
  renderFilters(data);
  
  // Default: Línea = Couture
  if (data['Linea'] && data['Linea'].options.includes('Couture')) {
    appState.activeFilters['Linea'] = ['Couture'];
    const lineaSelect = document.getElementById('filter_Linea');
    if (lineaSelect) {
      Array.from(lineaSelect.options).forEach(opt => {
        if (opt.value === 'Couture') {
          opt.selected = true;
        }
      });
      lineaSelect.style.fontWeight = '600';
    }
    updateAllDependentFilters();
  } else {
    loadAllData();
  }
}

function renderFilters(filterData) {
  const container = document.getElementById('filtersHorizontal');
  container.innerHTML = '';
  
  const orderedColumns = ['_Temp', 'Linea', 'Collection', 'Tienda', 'Cat_1', 'Cat_2', 'MODELO', 'COLOR', 'TALLA'];
  
  orderedColumns.forEach(columnName => {
    if (!filterData[columnName]) return;
    
    const filter = filterData[columnName];
    
    const filterGroup = document.createElement('div');
    filterGroup.className = 'filter-group';
    
    const label = document.createElement('label');
    label.className = 'filter-label';
    label.textContent = filter.label;
    
    const selectWrapper = document.createElement('div');
    selectWrapper.className = 'select-wrapper';
    
    const select = document.createElement('select');
    select.className = 'filter-select';
    select.id = `filter_${columnName}`;
    select.multiple = true;
    select.size = 1;
    
    filter.options.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt;
      option.textContent = opt;
      select.appendChild(option);
    });
    
    select.addEventListener('change', () => handleFilterChange(columnName, select));
    
    selectWrapper.appendChild(select);
    filterGroup.appendChild(label);
    filterGroup.appendChild(selectWrapper);
    container.appendChild(filterGroup);
  });
}

function handleFilterChange(columnName, selectElement) {
  const selectedOptions = Array.from(selectElement.selectedOptions)
    .map(opt => opt.value)
    .filter(val => val !== '');
  
  if (selectedOptions.length > 0) {
    appState.activeFilters[columnName] = selectedOptions;
    selectElement.style.fontWeight = '600';
  } else {
    delete appState.activeFilters[columnName];
    selectElement.style.fontWeight = '400';
  }
  
  updateAllDependentFilters();
}

function updateAllDependentFilters() {
  showLoading(true);
  
  const orderedColumns = ['Collection', 'Tienda', 'Cat_1', 'Cat_2', 'MODELO', 'COLOR', 'TALLA'];
  let completedUpdates = 0;
  const totalUpdates = orderedColumns.length;
  
  function checkComplete() {
    completedUpdates++;
    if (completedUpdates === totalUpdates) {
      loadAllData();
    }
  }
  
  orderedColumns.forEach(columnName => {
    const select = document.getElementById(`filter_${columnName}`);
    if (!select) {
      checkComplete();
      return;
    }
    
    google.script.run
      .withSuccessHandler(function(options) {
        updateSelectOptions(select, columnName, options);
        checkComplete();
      })
      .withFailureHandler(function(error) {
        console.error('Error actualizando ' + columnName, error);
        checkComplete();
      })
      .getFilterOptionsWithDependency(columnName, appState.activeFilters);
  });
}

function updateSelectOptions(selectElement, columnName, options) {
  const currentValues = appState.activeFilters[columnName] || [];
  
  selectElement.innerHTML = '';
  
  options.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt;
    option.textContent = opt;
    if (currentValues.includes(opt)) {
      option.selected = true;
    }
    selectElement.appendChild(option);
  });
  
  const validValues = currentValues.filter(v => options.includes(v));
  if (validValues.length !== currentValues.length) {
    if (validValues.length > 0) {
      appState.activeFilters[columnName] = validValues;
      selectElement.style.fontWeight = '600';
    } else {
      delete appState.activeFilters[columnName];
      selectElement.style.fontWeight = '400';
    }
  }
}

function clearAllAndSelections() {
  appState.activeFilters = {};
  appState.selectedStores = [];
  appState.selectedModels = [];
  appState.selectedCollections = [];
  appState.selectedCategorias = [];
  
  google.script.run
    .withSuccessHandler(function(data) {
      appState.filterData = data;
      renderFilters(data);
      
      if (data['Linea'] && data['Linea'].options.includes('Couture')) {
        appState.activeFilters['Linea'] = ['Couture'];
        const lineaSelect = document.getElementById('filter_Linea');
        if (lineaSelect) {
          Array.from(lineaSelect.options).forEach(opt => {
            if (opt.value === 'Couture') {
              opt.selected = true;
            }
          });
          lineaSelect.style.fontWeight = '600';
        }
        updateAllDependentFilters();
      } else {
        loadAllData();
      }
    })
    .withFailureHandler(onError)
    .getInitialFilterData();
}

// ========== CARGA DE DATOS ==========
function loadAllData() {
  showLoading(true);
  
  let completedCalls = 0;
  const totalCalls = 5;
  
  function checkComplete() {
    completedCalls++;
    if (completedCalls === totalCalls) {
      showLoading(false);
    }
  }
  
  google.script.run
    .withSuccessHandler(function(data) {
      onDataLoaded(data);
      checkComplete();
    })
    .withFailureHandler(onError)
    .getDashboardData(appState.activeFilters);
  
  google.script.run
    .withSuccessHandler(function(data) {
      appState.tiendasData = data;
      renderTableData('tiendas', data);
      checkComplete();
    })
    .withFailureHandler(onError)
    .getTableData(appState.activeFilters, appState.selectedModels, appState.selectedCollections, appState.selectedCategorias);
  
  google.script.run
    .withSuccessHandler(function(data) {
      appState.modelosData = data;
      renderTableData('modelos', data);
      checkComplete();
    })
    .withFailureHandler(onError)
    .getModelTableData(appState.activeFilters, appState.selectedStores, appState.selectedCollections, appState.selectedCategorias);
  
  google.script.run
    .withSuccessHandler(function(data) {
      appState.coleccionesData = data;
      renderTableData('colecciones', data);
      checkComplete();
    })
    .withFailureHandler(onError)
    .getCollectionTableData(appState.activeFilters, appState.selectedModels, appState.selectedStores, appState.selectedCategorias);
  
  google.script.run
    .withSuccessHandler(function(data) {
      appState.categoriasData = data;
      renderTableData('categorias', data);
      checkComplete();
    })
    .withFailureHandler(onError)
    .getCategoriaTableData(appState.activeFilters, appState.selectedModels, appState.selectedStores, appState.selectedCollections);
}

function onDataLoaded(data) {
  appState.globalSTPercent = data.porcentajeST;
  
  document.getElementById('kpiCompra').textContent = formatNumber(data.compra);
  document.getElementById('kpiVenta').textContent = formatNumber(data.venta);
  document.getElementById('kpiInventario').textContent = formatNumber(data.inventario);
  document.getElementById('kpiPorcentaje').textContent = formatPercentage(data.porcentajeST);
}

function renderTableData(tableType, data) {
  const tbodyId = {
    'tiendas': 'tableBodyTiendas',
    'modelos': 'tableBodyModelos',
    'colecciones': 'tableBodyColecciones',
    'categorias': 'tableBodyCategorias'
  }[tableType];
  
  const tbody = document.getElementById(tbodyId);
  tbody.innerHTML = '';
  
  data.forEach(row => {
    const tr = document.createElement('tr');
    
    if (tableType === 'tiendas') {
      tr.dataset.tienda = row.tienda;
      if (appState.selectedStores.includes(row.tienda)) tr.classList.add('selected');
      tr.addEventListener('click', () => handleStoreClick(row.tienda, tr));
      
      const td = document.createElement('td');
      td.textContent = row.tienda;
      td.title = row.tienda;
      tr.appendChild(td);
      
    } else if (tableType === 'modelos') {
      tr.dataset.modelo = row.modelo;
      if (appState.selectedModels.includes(row.modelo)) tr.classList.add('selected');
      tr.addEventListener('click', () => handleModelClick(row.modelo, tr));
      
      const tdModelo = document.createElement('td');
      tdModelo.textContent = row.modelo;
      tdModelo.title = row.modelo;
      tr.appendChild(tdModelo);
      
      // DEBUGGING - Ver qué está pasando
      console.log('--- RENDERIZANDO MODELO ---');
      console.log('Modelo:', row.modelo);
      console.log('Tipo de dato:', typeof row.modelo);
      console.log('¿Existe en catálogo?', row.modelo in appState.imagenesModelos);
      console.log('Catálogo tiene:', Object.keys(appState.imagenesModelos));
      
      // COLUMNA DE IMAGEN
      const tdImagen = document.createElement('td');
      tdImagen.className = 'model-image-cell';
      
      const imageUrl = appState.imagenesModelos[row.modelo];
      
      console.log('URL encontrada:', imageUrl);
      console.log('---------------------------');
      
      if (imageUrl) {
        const container = document.createElement('div');
        container.className = 'model-image-container';
        
        const img = document.createElement('img');
        img.src = imageUrl;
        img.className = 'model-image';
        img.alt = row.modelo;
        img.addEventListener('click', (e) => {
          e.stopPropagation();
          openImageModal(imageUrl);
        });
        
        container.appendChild(img);
        tdImagen.appendChild(container);
      } else {
        const noImage = document.createElement('div');
        noImage.className = 'model-no-image';
        noImage.textContent = 'SinFoto';
        tdImagen.appendChild(noImage);
      }
      
      tr.appendChild(tdImagen);
      
      const tdCategoria = document.createElement('td');
      tdCategoria.textContent = row.categoria;
      tr.appendChild(tdCategoria);
      
    } else if (tableType === 'colecciones') {
      tr.dataset.collection = row.collection;
      if (appState.selectedCollections.includes(row.collection)) tr.classList.add('selected');
      tr.addEventListener('click', () => handleCollectionClick(row.collection, tr));
      
      const td = document.createElement('td');
      td.textContent = row.collection;
      td.title = row.collection;
      tr.appendChild(td);
      
    } else if (tableType === 'categorias') {
      tr.dataset.categoria = row.categoria;
      if (appState.selectedCategorias.includes(row.categoria)) tr.classList.add('selected');
      tr.addEventListener('click', () => handleCategoriaClick(row.categoria, tr));
      
      const td = document.createElement('td');
      td.textContent = row.categoria;
      td.title = row.categoria;
      tr.appendChild(td);
    }
    
    const tdCompra = document.createElement('td');
    tdCompra.className = 'text-center';
    tdCompra.textContent = formatNumber(row.compra);
    
    const tdVenta = document.createElement('td');
    tdVenta.className = 'text-center';
    tdVenta.textContent = formatNumber(row.venta);
    
    const tdInventario = document.createElement('td');
    tdInventario.className = 'text-center';
    tdInventario.textContent = formatNumber(row.inventario);
    
    const tdPorcentaje = document.createElement('td');
    tdPorcentaje.className = 'text-right';
    tdPorcentaje.textContent = formatPercentage(row.porcentajeST);
    
    applyHeatmap(tdPorcentaje, row.porcentajeST, appState.globalSTPercent);
    
    tr.appendChild(tdCompra);
    tr.appendChild(tdVenta);
    tr.appendChild(tdInventario);
    tr.appendChild(tdPorcentaje);
    
    tbody.appendChild(tr);
  });
}

// ========== MODAL DE IMAGEN ==========
function openImageModal(imageUrl) {
  document.getElementById('imageModalContent').src = imageUrl;
  document.getElementById('imageModal').classList.add('active');
}

function closeImageModal() {
  document.getElementById('imageModal').classList.remove('active');
}

// ========== SORTING ==========
function handleSort(event, tableType) {
  const column = event.target.dataset.column;
  if (!column) return;
  
  const sortState = {
    'tiendas': appState.sortStateTiendas,
    'modelos': appState.sortStateModelos,
    'colecciones': appState.sortStateColecciones,
    'categorias': appState.sortStateCategorias
  }[tableType];
  
  if (sortState.column === column) {
    sortState.ascending = !sortState.ascending;
  } else {
    sortState.column = column;
    sortState.ascending = true;
  }
  
  const tableId = {
    'tiendas': 'dataTableTiendas',
    'modelos': 'dataTableModelos',
    'colecciones': 'dataTableColecciones',
    'categorias': 'dataTableCategorias'
  }[tableType];
  
  document.querySelectorAll(`#${tableId} th`).forEach(th => {
    th.classList.remove('sorted-asc', 'sorted-desc');
  });
  
  event.target.classList.add(sortState.ascending ? 'sorted-asc' : 'sorted-desc');
  
  const data = [...{
    'tiendas': appState.tiendasData,
    'modelos': appState.modelosData,
    'colecciones': appState.coleccionesData,
    'categorias': appState.categoriasData
  }[tableType]];
  
  data.sort((a, b) => {
    let valA = a[column];
    let valB = b[column];
    
    if (typeof valA === 'string') {
      valA = valA.toLowerCase();
      valB = valB.toLowerCase();
    }
    
    if (valA < valB) return sortState.ascending ? -1 : 1;
    if (valA > valB) return sortState.ascending ? 1 : -1;
    return 0;
  });
  
  renderTableData(tableType, data);
}

// ========== MANEJO DE SELECCIONES ==========
function handleStoreClick(tienda, rowElement) {
  const index = appState.selectedStores.indexOf(tienda);
  
  if (index > -1) {
    appState.selectedStores.splice(index, 1);
    rowElement.classList.remove('selected');
  } else {
    appState.selectedStores.push(tienda);
    rowElement.classList.add('selected');
  }
  
  reloadCrossFilteredTables();
}

function handleModelClick(modelo, rowElement) {
  const index = appState.selectedModels.indexOf(modelo);
  
  if (index > -1) {
    appState.selectedModels.splice(index, 1);
    rowElement.classList.remove('selected');
  } else {
    appState.selectedModels.push(modelo);
    rowElement.classList.add('selected');
  }
  
  reloadCrossFilteredTables();
}

function handleCollectionClick(collection, rowElement) {
  const index = appState.selectedCollections.indexOf(collection);
  
  if (index > -1) {
    appState.selectedCollections.splice(index, 1);
    rowElement.classList.remove('selected');
  } else {
    appState.selectedCollections.push(collection);
    rowElement.classList.add('selected');
  }
  
  reloadCrossFilteredTables();
}

function handleCategoriaClick(categoria, rowElement) {
  const index = appState.selectedCategorias.indexOf(categoria);
  
  if (index > -1) {
    appState.selectedCategorias.splice(index, 1);
    rowElement.classList.remove('selected');
  } else {
    appState.selectedCategorias.push(categoria);
    rowElement.classList.add('selected');
  }
  
  reloadCrossFilteredTables();
}

function updateKPIsFromSelections() {
  if (appState.selectedStores.length === 0 && 
      appState.selectedModels.length === 0 && 
      appState.selectedCollections.length === 0 && 
      appState.selectedCategorias.length === 0) {
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(data) {
      onDataLoaded(data);
    })
    .withFailureHandler(onError)
    .getKPIsFromSelections(
      appState.activeFilters,
      appState.selectedStores,
      appState.selectedModels,
      appState.selectedCollections,
      appState.selectedCategorias
    );
}

function reloadCrossFilteredTables() {
  showLoading(true);
  let completed = 0;
  
  function check() {
    completed++;
    if (completed === 5) showLoading(false);
  }
  
  updateKPIsFromSelections();
  check();
  
  google.script.run
    .withSuccessHandler(function(data) {
      appState.tiendasData = data;
      renderTableData('tiendas', data);
      check();
    })
    .withFailureHandler(onError)
    .getTableData(appState.activeFilters, appState.selectedModels, appState.selectedCollections, appState.selectedCategorias);
  
  google.script.run
    .withSuccessHandler(function(data) {
      appState.modelosData = data;
      renderTableData('modelos', data);
      check();
    })
    .withFailureHandler(onError)
    .getModelTableData(appState.activeFilters, appState.selectedStores, appState.selectedCollections, appState.selectedCategorias);
  
  google.script.run
    .withSuccessHandler(function(data) {
      appState.coleccionesData = data;
      renderTableData('colecciones', data);
      check();
    })
    .withFailureHandler(onError)
    .getCollectionTableData(appState.activeFilters, appState.selectedModels, appState.selectedStores, appState.selectedCategorias);
  
  google.script.run
    .withSuccessHandler(function(data) {
      appState.categoriasData = data;
      renderTableData('categorias', data);
      check();
    })
    .withFailureHandler(onError)
    .getCategoriaTableData(appState.activeFilters, appState.selectedModels, appState.selectedStores, appState.selectedCollections);
}

// ========== FORMATO DE HEATMAP ==========
function applyHeatmap(element, value, threshold) {
  for (let i = 0; i < 32; i++) {
    element.classList.remove(`heatmap-${i}`);
  }
  
  let normalizedValue;
  
  if (value >= threshold) {
    const range = Math.max(threshold * 0.5, 10);
    normalizedValue = 16 + Math.min(15, Math.floor(((value - threshold) / range) * 15));
  } else {
    normalizedValue = Math.floor((value / threshold) * 16);
  }
  
  normalizedValue = Math.max(0, Math.min(31, normalizedValue));
  element.classList.add(`heatmap-${normalizedValue}`);
}

function refreshData() {
  loadAllData();
}

// ========== UI HELPERS ==========
function showLoading(show) {
  document.getElementById('loading').classList.toggle('active', show);
}

function onError(error) {
  console.error('Error:', error);
  alert('Error al cargar datos: ' + error.message);
  showLoading(false);
}

// ========== FORMATEO ==========
function formatNumber(num) {
  return new Intl.NumberFormat('es-MX').format(Math.round(num));
}

function formatPercentage(num) {
  return Math.round(num) + '%';
}
</script>
```
